<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard | Fórmula 1 - Living is driving</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="../css/dashboard.css">
</head>

<body onload="carregarDashboard()">
    <div class="sidebar">
        <img src="../assets/imgs/Branco.png">
        <h1>Fórmula 1 - Living is driving</h1>
        <p>Olá, <span id="b_usuario">usuário</span>!</p>

        <a href="./dashboard.html">Dashboard</a>
        <a href="./quiz.html">Quiz</a>

        <button class="btn-logout" onclick="limparSessao()">
            <img src="../assets/imgs/Enter (1).svg"> Sair
        </button>
    </div>

    <div class="dash">
        <h2>Estatísticas Gerais</h2>

        <div class="cards-container">
            <div class="card estatistica-card">
                <h3>Total de Acertos</h3>
                <p id="totalAcertos">0</p>
            </div>
            <div class="card estatistica-card">
                <h3>Total de Erros</h3>
                <p id="totalErros">0</p>
            </div>
            <div class="card estatistica-card">
                <h3>Taxa de Acerto</h3>
                <p id="taxaAcerto">0%</p>
            </div>
        </div>

        <div class="graficos-container">
            <div class="grafico-card">
                <h3>Proporção Acertos x Erros</h3>
                <canvas id="graficoPizza"></canvas>
            </div>

            <div class="grafico-card">
                <h3>Evolução do Usuário</h3>
                <canvas id="graficoHistorico"></canvas>
            </div>
        </div>
    </div>

    <script>
        // Função para limpar sessão e fazer logout
        function limparSessao() {
            sessionStorage.clear();
            window.location.href = "../login.html";
        }

        // No dashboard.html
        const usuarioNome = sessionStorage.NOME_USUARIO || "Usuário";
        document.getElementById("b_usuario").innerText = usuarioNome;
        const idUsuario = sessionStorage.ID_USUARIO;

        function carregarDashboard() {
            if (!idUsuario) {
                console.error("ID do usuário não encontrado na sessão. Não é possível carregar a dashboard.");
                alert("Usuário não autenticado. Redirecionando para login...");
                window.location.href = "../login.html";
                return;
            }

            fetch(`/resultados/estatisticas/${idUsuario}`)
                .then(resposta => {
                    if (resposta.ok) {
                        return resposta.json();
                    }
                    if (resposta.status === 404) {
                        // Usuário sem dados ainda - inicializar com zeros
                        return {
                            estatisticasGerais: {
                                totalAcertos: 0,
                                totalErros: 0,
                                taxaAcerto: 0
                            },
                            historico: []
                        };
                    }
                    throw new Error("Erro ao carregar estatísticas. Status: " + resposta.status);
                })
                .then(dados => {
                    console.log("Dados recebidos do backend:", dados);

                    const { estatisticasGerais, historico } = dados;

                    // 1. Atualiza os KPIs com dados do banco
                    document.getElementById("totalAcertos").innerText = estatisticasGerais.totalAcertos || 0;
                    document.getElementById("totalErros").innerText = estatisticasGerais.totalErros || 0;
                    document.getElementById("taxaAcerto").innerText = (estatisticasGerais.taxaAcerto || 0) + "%";

                    // 2. Criar gráfico de pizza: Acertos x Erros
                    const ctxPizza = document.getElementById("graficoPizza").getContext("2d");
                    new Chart(ctxPizza, {
                        type: "pie",
                        data: {
                            labels: ["Acertos", "Erros"],
                            datasets: [{
                                data: [estatisticasGerais.totalAcertos || 0, estatisticasGerais.totalErros || 0],
                                backgroundColor: ["#4CAF50", "#F44336"]
                            }]
                        },
                        options: {
                            responsive: true,
                            plugins: {
                                legend: {
                                    position: 'bottom'
                                }
                            }
                        }
                    });

                    // 3. Gráfico de evolução do usuário (Histórico)
                    const ctxHistorico = document.getElementById("graficoHistorico").getContext("2d");
                    
                    // Preparar dados para o histórico
                    const labelsHistorico = historico.length > 0 
                        ? historico.map(h => h.dataPartida) 
                        : ['Nenhum dado'];
                    
                    const dataHistorico = historico.length > 0 
                        ? historico.map(h => h.totalAcertos) 
                        : [0];

                    new Chart(ctxHistorico, {
                        type: "line",
                        data: {
                            labels: labelsHistorico,
                            datasets: [{
                                label: "Acertos por Partida",
                                data: dataHistorico,
                                borderColor: "#2196F3",
                                backgroundColor: "rgba(33, 150, 243, 0.1)",
                                fill: true,
                                tension: 0.4
                            }]
                        },
                        options: {
                            responsive: true,
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    suggestedMax: Math.max(...dataHistorico) + 1 || 10
                                }
                            }
                        }
                    });

                }).catch(erro => {
                    console.error("Fetch Error:", erro);
                    alert("Não foi possível carregar os dados da dashboard. Tente novamente mais tarde.");
                });
        }
    </script>
</body>
</html>
