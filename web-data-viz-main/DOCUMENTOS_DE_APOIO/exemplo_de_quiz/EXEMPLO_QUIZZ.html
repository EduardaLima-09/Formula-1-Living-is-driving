<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Exemplo - Quiz</title>
    <link rel="stylesheet" href="style.css">
</head>


<body onload="onloadEsconder()">
    <div id="pontuacaoEJogo">
        <button id="btnIniciarQuiz" onclick="iniciarQuiz()">INICIAR QUIZ</button>

        <div id="pontuacao" class="flex-colunar width-fit-content border-primary">
            <div id="pontuacaoDuranteJogo" class="flex-colunar padding-8">
                <span class="width-fit-content">Quantidade de acertos: <span id="spanCertas"></span></span>
                <span class="width-fit-content">Quantidade de erros: <span id="spanErradas"></span></span>
            </div>
            <div id="pontuacaoFinalJogo" class="flex-colunar padding-8">
                <span id="pontuacaoFinal" class="width-fit-content">Pontuação Final:
                    <span id="spanPontuacaoFinal">***</span>
                </span>
                <span id="msgFinal" class="width-fit-content">***</span>
            </div>
        </div>

        <div id="jogo" class="width-fit-content flex-colunar border-secondary">

            <div id="infoQuestao" class="padding-8">
                <span>Questão atual: <span id="spanNumeroDaQuestaoAtual"></span> de <span id="qtdQuestoes"></span>
                    questões.</span>
            </div>

            <div id="perguntaDaQuestaoAtual" class="padding-8">
                <span id="spanQuestaoExibida" class="text-bold"></span>
            </div>

            <div id="infoAlternativas" class="padding-8">
                <span><em>Escolha uma opção dentre as abaixo:</em></span>
            </div>

            <div id="opcoes" class="flex-colunar padding-8">
                <span>
                    <input type="radio" id="primeiraOpcao" name="option" class="radio" value="alternativaA" />
                    <label for="primeiraOpcao" class="option" id="labelOpcaoUm"></label>
                </span>
                <span>
                    <input type="radio" id="segundaOpcao" name="option" class="radio" value="alternativaB" />
                    <label for="segundaOpcao" class="option" id="labelOpcaoDois"></label>
                </span>
                <span>
                    <input type="radio" id="terceiraOpcao" name="option" class="radio" value="alternativaC" />
                    <label for="terceiraOpcao" class="option" id="labelOpcaoTres"></label>
                </span>
                <span>
                    <input type="radio" id="quartaOpcao" name="option" class="radio" value="alternativaD" />
                    <label for="quartaOpcao" class="option" id="labelOpcaoQuatro"></label>
                </span>
            </div>

            <div id="botoes" class="flex-colunar padding-8">
                <button onclick="submeter()" id="btnSubmeter">Submeter resposta</button>
                <button onclick="avancar()" id="btnProx" disabled>Avançar para próxima questão</button>
                <!-- <button onclick="finalizar()" id="btnConcluir" disabled>Finalizar Quiz</button> -->
                <button onclick="tentarNovamente()" id="btnTentarNovamente" disabled>Tentar novamente</button>
            </div>

        </div>
    </div>
</body>

</html>
<script>
 let listaDeQuestoes = [];
let numeroDaQuestaoAtual = 0;
let pontuacaoFinal = 0;
let tentativaIncorreta = 0;
let certas = 0;
let erradas = 0;
let quantidadeDeQuestoes = 0;

function onloadEsconder() {
    document.getElementById('pontuacao').style.display = "none";
    document.getElementById('jogo').style.display = "none";
}

// Iniciar quiz
function iniciarQuiz() {
    document.getElementById('pontuacao').style.display = "flex";
    document.getElementById('jogo').style.display = "flex";
    document.getElementById('btnIniciarQuiz').style.display = "none";

    // Carregar perguntas do backend
    fetch('/quiz/perguntas')
        .then(res => res.json())
        .then(data => {
            listaDeQuestoes = data;
            quantidadeDeQuestoes = listaDeQuestoes.length;
            document.getElementById('qtdQuestoes').innerHTML = quantidadeDeQuestoes;
            preencherHTMLcomQuestaoAtual(0);

            btnSubmeter.disabled = false;
            btnProx.disabled = true;
            btnTentarNovamente.disabled = true;
        })
        .catch(err => console.error(err));
}

// Preencher a pergunta atual
function preencherHTMLcomQuestaoAtual(index) {
    habilitarAlternativas(true);
    const questaoAtual = listaDeQuestoes[index];
    numeroDaQuestaoAtual = index;

    document.getElementById("spanNumeroDaQuestaoAtual").innerHTML = index + 1;
    document.getElementById("spanQuestaoExibida").innerHTML = questaoAtual.pergunta;
    document.getElementById("labelOpcaoUm").innerHTML = questaoAtual.alternativaA;
    document.getElementById("labelOpcaoDois").innerHTML = questaoAtual.alternativaB;
    document.getElementById("labelOpcaoTres").innerHTML = questaoAtual.alternativaC;
    document.getElementById("labelOpcaoQuatro").innerHTML = questaoAtual.alternativaD;

    desmarcarRadioButtons();
    limparCoresBackgroundOpcoes();
}

// Habilitar/desabilitar opções
function habilitarAlternativas(trueOrFalse) {
    let opcaoEscolhida = trueOrFalse ? false : true;
    primeiraOpcao.disabled = opcaoEscolhida;
    segundaOpcao.disabled = opcaoEscolhida;
    terceiraOpcao.disabled = opcaoEscolhida;
    quartaOpcao.disabled = opcaoEscolhida;
}

// Submeter resposta
function submeter() {
    const options = document.getElementsByName("option");
    let hasChecked = Array.from(options).some(o => o.checked);

    if (!hasChecked) {
        alert("Escolha uma opção antes de submeter.");
        return;
    }

    btnSubmeter.disabled = true;
    btnProx.disabled = false;
    habilitarAlternativas(false);
    checarResposta();
}

// Checar resposta e enviar para backend
function checarResposta() {
    const questaoAtual = listaDeQuestoes[numeroDaQuestaoAtual];
    const respostaCorreta = questaoAtual.alternativaCorreta;

    const options = document.getElementsByName("option");
    let alternativaCorretaId = null;

    options.forEach((option) => {
        if (option.value === respostaCorreta) {
            alternativaCorretaId = option.labels[0].id;
        }
    });

    let acertou = 0;
    options.forEach((option) => {
        if (option.checked && option.value === respostaCorreta) {
            document.getElementById(alternativaCorretaId).classList.add("text-success-with-bg");
            pontuacaoFinal++;
            certas++;
            document.getElementById("spanCertas").innerHTML = certas;
            acertou = 1;
        } else if (option.checked && option.value !== respostaCorreta) {
            const wrongLabelId = option.labels[0].id;
            document.getElementById(wrongLabelId).classList.add("text-danger-with-bg");
            document.getElementById(alternativaCorretaId).classList.add("text-success-with-bg");
            tentativaIncorreta++;
            erradas++;
            document.getElementById("spanErradas").innerHTML = erradas;
        }
    });

    // Enviar resposta para o backend
    fetch('/quiz/responder', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
            fkUsuario: sessionStorage.ID_USUARIO,
            fkPergunta: questaoAtual.idPergunta,
            resposta: options.find(o => o.checked).value,
            acertou: acertou
        })
    }).catch(err => console.error(err));

    numeroDaQuestaoAtual++;
}

// Avançar para próxima questão
function avancar() {
    btnProx.disabled = true;
    btnSubmeter.disabled = false;

    if (numeroDaQuestaoAtual < quantidadeDeQuestoes) {
        preencherHTMLcomQuestaoAtual(numeroDaQuestaoAtual);
    } else {
        finalizarJogo();
    }
}

// Limpar cores de feedback
function limparCoresBackgroundOpcoes() {
    const options = document.getElementsByName("option");
    options.forEach((option) => {
        document.getElementById(option.labels[0].id).classList.remove("text-danger-with-bg");
        document.getElementById(option.labels[0].id).classList.remove("text-success-with-bg");
    });
}

// Desmarcar radios
function desmarcarRadioButtons() {
    const options = document.getElementsByName("option");
    options.forEach(o => o.checked = false);
}

// Finalizar quiz
function finalizarJogo() {
    const porcentagemFinalDeAcertos = pontuacaoFinal / quantidadeDeQuestoes;
    let textoParaMensagemFinal = "";
    let classComCoresParaMensagemFinal = "";

    if (porcentagemFinalDeAcertos <= 0.3) {
        textoParaMensagemFinal = "Parece que você não estudou...";
        classComCoresParaMensagemFinal = "text-danger-with-bg";
    } else if (porcentagemFinalDeAcertos < 0.9) {
        textoParaMensagemFinal = "Pode melhorar na próxima, hein!";
        classComCoresParaMensagemFinal = "text-warning-with-bg";
    } else {
        textoParaMensagemFinal = "Uau, parabéns!";
        classComCoresParaMensagemFinal = "text-success-with-bg";
    }

    textoParaMensagemFinal += `<br>Você acertou ${Math.round(porcentagemFinalDeAcertos*100)}% das questões.`;

    document.getElementById('msgFinal').innerHTML = textoParaMensagemFinal;
    document.getElementById('msgFinal').classList.add(classComCoresParaMensagemFinal);
    document.getElementById('spanPontuacaoFinal').innerHTML = pontuacaoFinal;

    document.getElementById('jogo').classList.add("text-new-gray");

    btnProx.disabled = true;
    btnSubmeter.disabled = true;
    btnTentarNovamente.disabled = false;
}

// Tentar novamente
function tentarNovamente() {
    window.location.reload();
}

</script>